<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My IIM Shillong Schedule</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px 10px;
            color: #ecf0f1;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px; /* Reduced margin for a cleaner look */
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .current-time {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .status-text {
            text-align: center;
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .status-text.connected {
            color: #2ecc71;
        }

        .status-text.disconnected {
            color: #e74c3c;
        }


        .day-section {
            background: rgba(44, 62, 80, 0.9);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease-in-out;
        }

        .day-section:hover {
            transform: translateY(-5px);
        }

        .day-title {
            font-size: 1.4em;
            color: #ecf0f1;
            margin-bottom: 15px;
            border-bottom: 2px solid #7f8c8d;
            padding-bottom: 8px;
            font-weight: 600;
        }

        .class-card {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 18px;
            border-radius: 14px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .class-card:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .class-time {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .class-name {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .class-details {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .progress-bar-container {
            background-color: #5d6d7e;
            border-radius: 10px;
            margin-bottom: 5px; /* Adjusted margin */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            padding: 5px;
        }

        .progress-bar {
            height: 25px;
            border-radius: 8px;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .progress-label {
            padding: 0 10px;
            white-space: nowrap;
        }

        .next-class-info {
            font-size: 0.9em;
            color: #bdc3c7;
            text-align: center;
            margin-bottom: 15px; /* Added spacing */
        }


        .progress-card .class-name {
            font-size: 1.1em;
        }

        .progress-card .class-details {
            font-weight: 500;
        }

        .no-classes, .loading {
            text-align: center;
            color: #bdc3c7;
            font-style: italic;
            padding: 30px 10px;
            font-size: 1em;
        }
        
        .no-classes.success {
            color: #2ecc71;
            font-style: normal;
            font-weight: bold;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c0392b;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-input, .class-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #5d6d7e;
            border-radius: 10px;
            font-size: 1em;
            background-color: #34495e;
            color: white;
            transition: border-color 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .date-input:focus, .class-select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        .class-select {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e67e22;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 1.1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            background: #d35400;
            transform: scale(1.1);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        .error-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #34495e;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .error-table th, .error-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #5d6d7e;
            color: #ecf0f1;
        }
        
        .error-table th {
            background-color: #2c3e50;
            color: #bdc3c7;
            font-weight: 600;
        }

        .error-table tr:last-child td {
            border-bottom: none;
        }
        
        /* New styling for less prominent error section */
        .unimportant-error-title {
            font-size: 1.2em;
            color: #bdc3c7;
            border-bottom: 1px solid #7f8c8d;
        }

        /* --- New UI for Subject Selection (Search & Tags) --- */
        .search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .subject-search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #5d6d7e;
            border-radius: 10px;
            font-size: 1em;
            background-color: #34495e;
            color: white;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .subject-search-input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        
        .search-results-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: #34495e;
            border: 1px solid #5d6d7e;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            display: none; /* Initially hidden */
        }
        
        .search-results-list.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #ecf0f1;
        }
        
        .search-result-item:hover {
            background-color: #5d6d7e;
        }
        
        .selected-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .selected-tag {
            background-color: #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.9em;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .selected-tag .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .selected-tag .remove-tag:hover {
            color: #e74c3c;
        }

        .weekly-schedule-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .weekly-schedule-container.expanded {
            max-height: 2000px; /* Large enough value to show all content */
        }
        
        .weekly-schedule-day {
            background: rgba(44, 62, 80, 0.9);
            border-radius: 18px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .weekly-schedule-day h3 {
            color: #ecf0f1;
            font-size: 1.1em;
            margin-bottom: 10px;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 5px;
        }

        /* Responsive adjustments for phones */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .day-title {
                font-size: 1.2em;
            }

            .btn, .date-input, .subject-search-input, .search-result-item {
                font-size: 0.9em;
            }
            
            .search-section {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .search-section .btn {
                width: 100%;
            }

            .refresh-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1em;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö My IIM Shillong Schedule</h1>
            <p id="connectionStatus" class="status-text connected">Connected</p>
        </div>

        <div id="scheduleContent">
            
            <div class="day-section">
                <h2 class="day-title">‚úÖ Select Your Classes</h2>
                <div class="search-container">
                    <input type="text" id="subjectSearchInput" class="subject-search-input" placeholder="Search for a subject...">
                    <div id="searchResults" class="search-results-list"></div>
                </div>
                <div id="selectedTagsContainer" class="selected-tags-container"></div>
                
                <button class="btn" onclick="updateEnrolledClassesAndRefresh()" style="margin-top: 15px;">Update Schedule</button>
            </div>

            <div class="day-section">
                <h2 class="day-title">üìÖ Today - <span id="todayDate"></span></h2>
                <div id="todayClasses" class="loading">Loading today's classes...</div>
            </div>

            <div class="day-section">
                <h2 class="day-title">‚è≠Ô∏è Tomorrow - <span id="tomorrowDate"></span></h2>
                <div id="tomorrowClasses" class="loading">Loading tomorrow's classes...</div>
            </div>
            
            <!-- New Weekly Schedule Section -->
            <div class="day-section">
                <h2 class="day-title">My Weekly Schedule</h2>
                <button class="btn" onclick="toggleWeeklySchedule()">Show Weekly Schedule</button>
                <div id="weeklyScheduleContainer" class="weekly-schedule-container">
                    <!-- Weekly schedule will be rendered here -->
                </div>
            </div>

            <!-- New section for subject details -->
            <div class="day-section">
                <h2 class="day-title">üìä Your Subject Progress</h2>
                <div id="subjectDetailsContainer" class="loading">Loading subject details...</div>
            </div>

            <div class="day-section">
                <h2 class="day-title">üîç Search by Date</h2>
                <div class="search-section">
                    <input type="date" id="datePicker" class="date-input">
                    <button class="btn" onclick="fetchClassesForDate()">Show Schedule</button>
                </div>
                <div id="selectedDateClasses"></div>
            </div>

            <!-- New section for potential scheduling errors -->
            <div class="day-section">
                <h2 class="day-title unimportant-error-title">Potential Scheduling Errors</h2>
                <div id="errorSubjectsContainer" class="loading">Checking for errors...</div>
            </div>

        </div>
    </div>

    <button class="refresh-btn" id="refreshBtn" onclick="refreshData()" title="Refresh Data">
        üîÑ
    </button>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration from the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Custom auth token provided by the environment
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Asynchronously signs in the user with a custom token or anonymously.
         * @returns {Promise<void>}
         */
        async function signInUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log(`User signed in with ID: ${userId}`);
            } catch (error) {
                console.error("Firebase Auth error:", error);
            }
        }

        /**
         * Fetches user's saved class preferences from Firestore.
         * @returns {Promise<string[]|null>} A promise that resolves with an array of saved classes or null.
         */
        async function fetchUserPreferences() {
            if (!userId) {
                return null;
            }
            try {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/preferences/classPreferences`);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    console.log("User preferences found:", docSnap.data().enrolledClasses);
                    return docSnap.data().enrolledClasses;
                } else {
                    console.log("No user preferences found. Using default classes.");
                    return null;
                }
            } catch (e) {
                console.error("Error fetching preferences:", e);
                return null;
            }
        }

        /**
         * Saves the user's selected classes to Firestore.
         * @param {string[]} classesToSave The array of class names to save.
         * @returns {Promise<void>}
         */
        async function saveUserPreferences(classesToSave) {
            if (!userId) {
                return;
            }
            try {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/preferences/classPreferences`);
                await setDoc(docRef, { enrolledClasses: classesToSave });
                showSuccess('Your class selections have been saved.');
            } catch (e) {
                showError('Failed to save your class selections.');
                console.error("Error saving preferences:", e);
            }
        }
        
        // Expose Firebase functions to the global scope
        window.signInUser = signInUser;
        window.fetchUserPreferences = fetchUserPreferences;
        window.saveUserPreferences = saveUserPreferences;
        window.db = db;
    </script>
    <script>
        const API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1386awb-Qw-_ld03zlXFNfkkHi7N9XY4LwirxQtkMpZk/values/New!A1:D1300?key=AIzaSyBQps5D4hUe8owgZOe4-qgFwoXwl5x6ATo';
        
        let refreshInterval;
        let allSheetData = [];
        let enrolledClasses = ['IBA (S2)', 'DBTS (S2)', 'B2B', 'DOPM', 'SAPM (S2)'];
        const allClasses = [
            'B2B', 'BIA', 'CB', 'CBV', 'CMME', 'CS (S1)', 'CS (S2)', 'CSIE', 'CRM', 'DAP', 
            'DBTS (S1)', 'DBTS (S2)', 'DMEC', 'DOPM', 'FIS', 'FT', 'GRSC', 'GTBL', 'IBA (S1)', 
            'IBA (S2)', 'IBBV (S1)', 'IBBV (S2)', 'IMC', 'OSCA', 'PM', 'RM (S1)', 'RM (S2)',
            'SAPM (S1)', 'SAPM (S2)', 'SC', 'SCM (S1)', 'SCM (S2)', 'SIMCO (S1)', 'SIMCO (S2)'
        ];

        // Function to update the connection status text
        function setConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                if (isConnected) {
                    statusElement.textContent = 'Connected';
                    statusElement.classList.remove('disconnected');
                    statusElement.classList.add('connected');
                } else {
                    statusElement.textContent = 'Can\'t Connect';
                    statusElement.classList.remove('connected');
                    statusElement.classList.add('disconnected');
                }
            }
        }
        
        function initializeDates() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            document.getElementById('todayDate').textContent = 
                today.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            document.getElementById('tomorrowDate').textContent = 
                tomorrow.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        async function fetchSheetData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                return data.values || [];
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            
            const cleaned = dateString.trim();
            const parts = cleaned.split('/');
            if (parts.length === 3) {
                const month = parseInt(parts[0], 10);
                const day = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                    const isoDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(isoDate);
                    if (!isNaN(date.getTime()) && date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day) {
                        return date;
                    }
                }
            }
            const fallbackDate = new Date(cleaned);
            if (!isNaN(fallbackDate.getTime())) {
                return fallbackDate;
            }
            return null;
        }

        function isSameDay(date1, date2) {
            if (!date1 || !date2) return false;
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        function isPastDate(date) {
            if (!date) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const classDate = new Date(date);
            classDate.setHours(0, 0, 0, 0);
            return classDate.getTime() < today.getTime();
        }

        function parseClassInfo(classString) {
            if (!classString) return { class: '', instructor: '' };
            
            let class_name = classString.trim();
            let instructor = '';
            
            const separatorIndex = classString.indexOf(' - ');
            const suffixRegex = /\s\((S1|S2)\)$/;
            
            const suffixMatch = class_name.match(suffixRegex);
            if (suffixMatch) {
                const parts = class_name.split(suffixMatch[0]);
                class_name = parts[0].trim() + suffixMatch[0];
            } else if (separatorIndex !== -1) {
                class_name = classString.substring(0, separatorIndex).trim();
                instructor = classString.substring(separatorIndex + 3).trim();
            } else {
                const parenthesisIndex = classString.lastIndexOf('(');
                if (parenthesisIndex !== -1 && classString.endsWith(')')) {
                    const content = classString.substring(parenthesisIndex + 1, classString.length - 1).trim();
                    if (!['S1', 'S2'].includes(content)) {
                        class_name = classString.substring(0, parenthesisIndex).trim();
                        instructor = content;
                    }
                }
            }
            return { class: class_name, instructor: instructor };
        }

        function filterClassesByDate(data, targetDate, classesToFilterBy) {
            if (!data || data.length < 2) return [];
            
            const rows = data.slice(1);
            
            return rows.filter(row => {
                if (row.length === 0 || !row[0]) return false;
                const classDate = parseDate(row[0]);
                const classInfo = parseClassInfo(row[2] || '');
                return classDate && isSameDay(classDate, targetDate) && classesToFilterBy.includes(classInfo.class);
            }).map(row => {
                const classInfo = parseClassInfo(row[2] || '');
                return {
                    date: row[0] || '',
                    time: row[1] || '',
                    class: classInfo.class,
                    instructor: classInfo.instructor,
                    location: row[3] || ''
                };
            }).sort((a, b) => {
                const timeA = a.time.toLowerCase();
                const timeB = b.time.toLowerCase();
                return timeA.localeCompare(timeB);
            });
        }
        
        function renderClasses(classes, containerId) {
            const container = document.getElementById(containerId);
            if (classes.length === 0) {
                container.innerHTML = '<div class="no-classes">No classes scheduled</div>';
                return;
            }
            container.innerHTML = classes.map(cls => `
                <div class="class-card">
                    <div class="class-time">üïí ${cls.time}</div>
                    <div class="class-name">${cls.class}</div>
                    <div class="class-details">
                        ${cls.location ? `üìç ${cls.location}` : ''}
                        ${cls.instructor ? ` ‚Ä¢ üë®‚Äçüè´ ${cls.instructor}` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function renderSubjectDetails() {
            const container = document.getElementById('subjectDetailsContainer');
            if (enrolledClasses.length === 0) {
                container.innerHTML = '<div class="no-classes">No subjects selected. Please select your classes above.</div>';
                return;
            }
            container.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const htmlBars = enrolledClasses.map(subject => {
                const allSubjectClasses = allSheetData.slice(1).filter(row => {
                    const classInfo = parseClassInfo(row[2] || '');
                    return classInfo.class === subject;
                });
                const totalClasses = allSubjectClasses.length;
                const completedClasses = allSubjectClasses.filter(row => {
                    const classDate = parseDate(row[0]);
                    return classDate && isPastDate(classDate);
                }).length;
                const progressPercentage = totalClasses > 0 ? (completedClasses / totalClasses) * 100 : 0;
                
                const upcomingClasses = allSubjectClasses
                    .filter(row => {
                        const classDate = parseDate(row[0]);
                        return classDate && classDate.getTime() >= today.getTime();
                    })
                    .map(row => {
                        const classInfo = parseClassInfo(row[2] || '');
                        return {
                            date: parseDate(row[0]),
                            time: row[1] || ''
                        };
                    })
                    .sort((a, b) => {
                        if (a.date.getTime() !== b.date.getTime()) {
                            return a.date.getTime() - b.date.getTime();
                        }
                        return a.time.localeCompare(b.time);
                    });

                let nextClassInfo = 'No upcoming classes';
                if (upcomingClasses.length > 0) {
                    const nextClass = upcomingClasses[0];
                    const nextClassDate = nextClass.date.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    nextClassInfo = `Next: ${nextClassDate} at ${nextClass.time}`;
                }

                return `
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progressPercentage}%;">
                            <span class="progress-label">${subject}: ${completedClasses} / ${totalClasses}</span>
                        </div>
                    </div>
                    <div class="next-class-info">${nextClassInfo}</div>
                `;
            }).join('');
            container.innerHTML = htmlBars;
        }
        
        function renderWeeklySchedule(data) {
            const container = document.getElementById('weeklyScheduleContainer');
            if (!data || data.length === 0) {
                 container.innerHTML = '<div class="no-classes">No data available. Please refresh.</div>';
                 return;
            }

            container.innerHTML = '';
            
            const today = new Date();
            const daysToShow = 7;
            
            let allWeeksClasses = [];
            for (let i = 0; i < daysToShow; i++) {
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + i);
                const dayClasses = filterClassesByDate(allSheetData, targetDate, enrolledClasses);
                
                if (dayClasses.length > 0) {
                    allWeeksClasses.push({ date: targetDate, classes: dayClasses });
                }
            }

            if (allWeeksClasses.length === 0) {
                container.innerHTML = '<div class="no-classes">No classes scheduled for the next 7 days.</div>';
                return;
            }
            
            const weekHtml = allWeeksClasses.map(day => {
                const dayTitle = day.date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                const classCardsHtml = day.classes.map(cls => `
                    <div class="class-card">
                        <div class="class-time">üïí ${cls.time}</div>
                        <div class="class-name">${cls.class}</div>
                        <div class="class-details">
                            ${cls.location ? `üìç ${cls.location}` : ''}
                            ${cls.instructor ? ` ‚Ä¢ üë®‚Äçüè´ ${cls.instructor}` : ''}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="weekly-schedule-day">
                        <h3>${dayTitle}</h3>
                        ${classCardsHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = weekHtml;
        }

        function toggleWeeklySchedule() {
            const container = document.getElementById('weeklyScheduleContainer');
            container.classList.toggle('expanded');
            if (container.classList.contains('expanded') && allSheetData.length > 0) {
                renderWeeklySchedule(allSheetData);
            } else if (container.classList.contains('expanded') && allSheetData.length === 0) {
                 container.innerHTML = '<div class="loading">Fetching data for weekly schedule...</div>';
                 fetchSheetData().then(data => {
                    allSheetData = data;
                    renderWeeklySchedule(allSheetData);
                 }).catch(() => {
                    container.innerHTML = '<div class="no-classes disconnected">Failed to fetch schedule data.</div>';
                 });
            }
        }


        function findSchedulingErrors() {
            const container = document.getElementById('errorSubjectsContainer');
            if (!allSheetData || allSheetData.length === 0) {
                container.innerHTML = '<div class="loading">Loading data to check for errors...</div>';
                return;
            }
            
            const subjectCounts = {};
            allSheetData.slice(1).forEach(row => {
                const subject = parseClassInfo(row[2] || '').class;
                if (subject) {
                    subjectCounts[subject] = (subjectCounts[subject] || 0) + 1;
                }
            });
            const subjectsToCheck = [
                'B2B', 'BIA', 'CB', 'CBV', 'CMME', 'CS (S1)', 'CS (S2)', 'CSIE', 'CRM', 'DAP', 
                'DBTS (S1)', 'DBTS (S2)', 'DMEC', 'DOPM', 'FIS', 'FT', 'GRSC', 'GTBL', 'IBA (S1)', 
                'IBA (S2)', 'IBBV (S1)', 'IBBV (S2)', 'IMC', 'OSCA', 'PM', 'RM (S1)', 'RM (S2)',
                'SAPM (S1)', 'SAPM (S2)', 'SC', 'SCM (S1)', 'SCM (S2)', 'SIMCO (S1)', 'SIMCO (S2)'
            ];

            const errorSubjects = subjectsToCheck.filter(subject => {
                const count = subjectCounts[subject] || 0;
                return count !== 20;
            });
            if (errorSubjects.length === 0) {
                container.innerHTML = '<div class="no-classes success">‚úÖ All specified subjects have a total of 20 classes.</div>';
            } else {
                let tableHtml = '<table class="error-table"><thead><tr><th>Subject</th><th>Number of Scheduled Classes</th></tr></thead><tbody>';
                errorSubjects.forEach(subject => {
                    const count = subjectCounts[subject] || 0;
                    tableHtml += `<tr><td>${subject}</td><td>${count}</td></tr>`;
                });
                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
            }
        }

        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('spinning');
            
            try {
                const data = await fetchSheetData();
                allSheetData = data;
                setConnectionStatus(true);
                
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                const todayClasses = filterClassesByDate(allSheetData, today, enrolledClasses);
                const tomorrowClasses = filterClassesByDate(allSheetData, tomorrow, enrolledClasses);

                renderClasses(todayClasses, 'todayClasses');
                renderClasses(tomorrowClasses, 'tomorrowClasses');
                renderSubjectDetails();
                findSchedulingErrors();

                const now = new Date();
                console.log(`Data refreshed at ${now.toLocaleTimeString()}`);
            } catch (error) {
                setConnectionStatus(false);
                showError('Failed to refresh data: ' + error.message);
                console.error('Refresh error:', error);
            } finally {
                refreshBtn.classList.remove('spinning');
            }
        }
        
        async function fetchClassesForDate() {
            const dateInput = document.getElementById('datePicker');
            const selectedDate = new Date(dateInput.value);

            if (isNaN(selectedDate.getTime())) {
                showError('Please select a valid date.');
                return;
            }
            const container = document.getElementById('selectedDateClasses');
            container.innerHTML = '<div class="loading">Loading schedule...</div>';
            try {
                if (allSheetData.length === 0) {
                     allSheetData = await fetchSheetData();
                }
                const classes = filterClassesByDate(allSheetData, selectedDate, enrolledClasses);
                renderClasses(classes, 'selectedDateClasses');
            } catch (error) {
                showError('Failed to fetch schedule for the selected date.');
                console.error('Date search error:', error);
            }
        }
        
        async function updateEnrolledClassesAndRefresh() {
            await saveUserPreferences(enrolledClasses);
            refreshData();
            const dateInput = document.getElementById('datePicker');
            if (dateInput.value) {
                fetchClassesForDate();
            }
        }
        
        function renderSelectedTags() {
            const container = document.getElementById('selectedTagsContainer');
            container.innerHTML = '';
            enrolledClasses.forEach(subject => {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
                tag.innerHTML = `
                    <span>${subject}</span>
                    <span class="remove-tag" data-subject="${subject}">x</span>
                `;
                container.appendChild(tag);
            });
            container.querySelectorAll('.remove-tag').forEach(tag => {
                tag.addEventListener('click', (event) => {
                    const subjectToRemove = event.target.dataset.subject;
                    enrolledClasses = enrolledClasses.filter(s => s !== subjectToRemove);
                    renderSelectedTags();
                });
            });
        }
        
        function renderSearchResults(query) {
            const resultsContainer = document.getElementById('searchResults');
            const trimmedQuery = query.trim().toLowerCase();
            
            if (trimmedQuery.length === 0) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.remove('active');
                return;
            }
            
            const filteredClasses = allClasses.filter(subject => 
                subject.toLowerCase().includes(trimmedQuery) && !enrolledClasses.includes(subject)
            );
            
            if (filteredClasses.length > 0) {
                resultsContainer.innerHTML = filteredClasses.map(subject => `
                    <div class="search-result-item" data-subject="${subject}">${subject}</div>
                `).join('');
                resultsContainer.classList.add('active');
            } else {
                resultsContainer.innerHTML = `<div class="search-result-item">No subjects found.</div>`;
                resultsContainer.classList.add('active');
            }
            
            resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    const subjectToAdd = event.target.dataset.subject;
                    if (subjectToAdd && !enrolledClasses.includes(subjectToAdd)) {
                        enrolledClasses.push(subjectToAdd);
                        enrolledClasses.sort();
                        renderSelectedTags();
                        document.getElementById('subjectSearchInput').value = '';
                        resultsContainer.classList.remove('active');
                    }
                });
            });
        }
        
        function startAutoRefresh() {
            const refreshIntervalMinutes = 90;
            refreshInterval = setInterval(refreshData, refreshIntervalMinutes * 60 * 1000);
            refreshData();
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'background: #2ecc71; color: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #27ae60;';
            successDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        async function initialize() {
            initializeDates();
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            document.getElementById('datePicker').value = `${year}-${month}-${day}`;

            try {
                await signInUser();
                const savedClasses = await fetchUserPreferences();
                if (savedClasses) {
                    enrolledClasses = savedClasses;
                }
            } catch (error) {
                console.error("Initialization failed:", error);
            }
            
            document.getElementById('subjectSearchInput').addEventListener('input', (event) => {
                renderSearchResults(event.target.value);
            });
            
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.search-container')) {
                    document.getElementById('searchResults').classList.remove('active');
                }
            });

            renderSelectedTags();

            fetchSheetData()
                .then(data => {
                    allSheetData = data;
                    showSuccess('Successfully connected to your class schedule!');
                    startAutoRefresh();
                })
                .catch(error => {
                    showError('Failed to connect to Google Sheet: ' + error.message);
                    setConnectionStatus(false);
                    console.error('Initialization error:', error);
                });
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>
