<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Schedule</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F0F4F8;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            border: 1px solid #E2E8F0;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .card-title {
            font-weight: 600;
            color: #2D3748;
        }
        .class-card {
            background-color: #4A5568;
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #4A90E2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn {
            background-color: #4A90E2;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #357ABD;
        }
        .btn.active {
            background-color: #2D3748;
        }
        .btn.secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }
        .btn.secondary:hover {
            background-color: #CBD5E0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- CALENDAR STYLES --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #F7FAFC;
            color: #A0AEC0;
        }
        .calendar-day-header {
            font-weight: 600;
            color: #4A5568;
            background-color: transparent;
        }
        .day-free { background-color: #C6F6D5; color: #2F855A; }
        .day-bunk { background-color: #FEFCBF; color: #B7791F; cursor: help; }
        .day-busy { background-color: #FED7D7; color: #C53030; }
        .day-outside-term { background-color: #EDF2F7; color: #A0AEC0; }
        .day-light-load { background-color: #BEE3F8; color: #2C5282; }
        .day-medium-load { background-color: #63B3ED; color: #1A365D; }
        .day-heavy-load { background-color: #3182CE; color: #EBF8FF; }

        .add-to-calendar-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 1.2rem;
            transition: background-color 0.2s;
        }
        .add-to-calendar-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#2D3748]">Class Schedule üìö</h1>
            <p id="connectionStatus" class="text-gray-500 mt-2">Connecting...</p>
        </header>

        <!-- Main Content -->
        <main id="scheduleContent" class="flex flex-col gap-6">
            
            <!-- Select Your Classes -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">‚úÖ My Subjects</h2>
                <div class="relative mb-4">
                    <input type="text" id="subjectSearchInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Search and add a subject...">
                    <div id="searchResults" class="absolute top-full left-0 w-full bg-white border border-gray-300 rounded-b-lg z-10 hidden max-h-60 overflow-y-auto"></div>
                </div>
                <div id="selectedTagsContainer" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="updateScheduleBtn" class="btn w-full">Update My Schedule</button>
                    <button id="downloadMonthBtn" class="btn w-full !bg-green-500 hover:!bg-green-600 leading-tight">Download my latest custom calendar</button>
                </div>
            </div>

            <!-- Today & Tomorrow -->
            <section class="grid md:grid-cols-2 gap-6">
                <div class="card">
                    <h2 class="card-title text-xl mb-4">üìÖ Today <span class="text-gray-400 font-normal text-sm" id="todayDate"></span></h2>
                    <div id="todayClasses"><div class="loader"></div></div>
                </div>
                <div class="card">
                    <h2 class="card-title text-xl mb-4">‚è≠Ô∏è Tomorrow <span class="text-gray-400 font-normal text-sm" id="tomorrowDate"></span></h2>
                    <div id="tomorrowClasses"><div class="loader"></div></div>
                </div>
            </section>

            <!-- Upcoming Classes -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">‚û°Ô∏è Upcoming Schedule</h2>
                <div class="flex gap-2 mb-4">
                    <button id="dayWiseBtn" class="btn active flex-grow">Day-wise</button>
                    <button id="subjectWiseBtn" class="btn secondary flex-grow">Subject-wise</button>
                </div>
                <div id="upcomingClassesContainer"><div class="loader"></div></div>
            </div>

            <!-- My Calendar View -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">üóìÔ∏è My Term Calendar</h2>
                <p class="text-sm text-gray-500 mb-4">Generate a color-coded calendar for your subjects during the term (10 Sep - 6 Dec).</p>
                <button id="showMyCalendarBtn" class="btn w-full">Show My Calendar</button>
                <div id="myCalendarResults" class="mt-4"></div>
            </div>

            <!-- Search by Date -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">üîç Search by Date</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="date" id="datePicker" class="w-full p-3 border border-gray-300 rounded-lg">
                    <button id="showScheduleBtn" class="btn w-full md:w-auto">Show Schedule</button>
                </div>
                <div id="selectedDateClasses" class="mt-4"></div>
            </div>
            
            <!-- Match Free Time with Friend -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">ü§ù Match Free Time with a Friend</h2>
                <p class="text-sm text-gray-500 mb-4">Enter your friend's subjects to generate a visual calendar of your common free time during the term (10 Sep - 6 Dec).</p>
                
                <h3 class="font-semibold text-lg mb-2 text-gray-700">üßë‚Äçü§ù‚Äçüßë Friend's Subjects</h3>
                <div class="relative mb-4">
                    <input type="text" id="friendSubjectSearchInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Search and add friend's subject...">
                    <div id="friendSearchResults" class="absolute top-full left-0 w-full bg-white border border-gray-300 rounded-b-lg z-10 hidden max-h-60 overflow-y-auto"></div>
                </div>
                <div id="friendSelectedTagsContainer" class="flex flex-wrap gap-2 mb-4"></div>

                <button id="compareSchedulesBtn" class="btn w-full !bg-purple-500 hover:!bg-purple-600">Generate Visual Calendar</button>
                
                <div id="comparisonResults" class="mt-4"></div>
            </div>

        </main>
    </div>

    <!-- Floating Refresh Button -->
    <button class="refresh-btn fixed bottom-5 right-5 bg-blue-500 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-2xl" id="refreshBtn" title="Refresh Data">
        üîÑ
    </button>
    
    <script>
        // --- APPLICATION LOGIC ---
        const API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1386awb-Qw-_ld03zlXFNfkkHi7N9XY4LwirxQtkMpZk/values/New!A1:N1300?key=AIzaSyBQps5D4hUe8owgZOe4-qgFwoXwl5x6ATo';
        
        let allSheetData = [];
        let enrolledClasses = [];
        let friendEnrolledClasses = [];
        let activeUpcomingView = 'dayWise';
        let allClasses = [];
        let venueMap = {};
        let professorMap = {};

        // --- UTILITY FUNCTIONS ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.trim().split('/');
            if (parts.length === 3) {
                const [month, day, year] = parts.map(p => parseInt(p, 10));
                if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                    const fullYear = year < 100 ? 2000 + year : year;
                    return new Date(fullYear, month - 1, day);
                }
            }
            return null;
        }

        function isSameDay(d1, d2) {
            if (!d1 || !d2) return false;
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        }

        function parseClassInfo(classString) {
            if (!classString) return { class: 'Unnamed Class' };
            return { class: classString.trim() };
        }

        function parseTime(timeStr) {
            if (!timeStr) return { hours: NaN, minutes: NaN };
            const parts = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
            if (!parts) return { hours: NaN, minutes: NaN };
            let hours = parseInt(parts[1], 10);
            const minutes = parseInt(parts[2], 10);
            const modifier = parts[3];
            if (isNaN(hours) || isNaN(minutes)) return { hours: NaN, minutes: NaN };
            if (modifier) {
                if (modifier.toUpperCase() === 'PM' && hours < 12) hours += 12;
                if (modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
            }
            return { hours, minutes };
        }

        // --- ICS FILE GENERATION ---
        function downloadICS(filename, content) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toUTCFormat(date) {
            return date.toISOString().replace(/[-:.]/g, '').slice(0, -4) + 'Z';
        }

        function createGoogleCalendarLink(cls) {
            const classDate = parseDate(cls.date);
            if (!classDate) return '#';
            const timeParts = (cls.time || '').split('-').map(t => t.trim());
            if (timeParts.length < 2) return '#';
            const { hours: startHours, minutes: startMinutes } = parseTime(timeParts[0]);
            const { hours: endHours, minutes: endMinutes } = parseTime(timeParts[1]);
            if (isNaN(startHours) || isNaN(endHours)) return '#';
            const startDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), startHours, startMinutes);
            const endDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), endHours, endMinutes);
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return '#';
            const baseURL = 'https://www.google.com/calendar/render?action=TEMPLATE';
            const params = new URLSearchParams({
                text: cls.class,
                dates: `${toUTCFormat(startDate)}/${toUTCFormat(endDate)}`,
                details: `Professor: ${cls.professor || 'N/A'}`,
                location: cls.location || 'Venue not listed'
            });
            return `${baseURL}&${params.toString()}`;
        }
        
        function generateMonthlyICS() {
            if (enrolledClasses.length === 0) {
                showToast('Please select your subjects first.', 'error');
                return;
            }
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            const eventsForNextMonth = allSheetData
                .map(row => {
                    const classDate = parseDate(row[0]);
                    const classInfo = parseClassInfo(row[2] || '');
                    const classNameFromSheetLower = classInfo.class.toLowerCase();

                    if (classDate && classDate >= today && classDate <= nextMonth && enrolledClasses.some(enrolled => classNameFromSheetLower.includes(enrolled.toLowerCase()))) {
                        return {
                            date: row[0], time: row[1], class: classInfo.class,
                            location: venueMap[classInfo.class], professor: professorMap[classInfo.class]
                        };
                    }
                    return null;
                }).filter(Boolean);

            if (eventsForNextMonth.length === 0) { showToast('No classes found for your subjects in the next 30 days.'); return; }
            let icsEvents = eventsForNextMonth.map(cls => {
                const classDate = parseDate(cls.date); if (!classDate) return '';
                const timeParts = (cls.time || '').split('-').map(t => t.trim()); if (timeParts.length < 2) return '';
                const { hours: startHours, minutes: startMinutes } = parseTime(timeParts[0]);
                const { hours: endHours, minutes: endMinutes } = parseTime(timeParts[1]);
                if (isNaN(startHours) || isNaN(endHours)) return '';
                const startDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), startHours, startMinutes);
                const endDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), endHours, endMinutes);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return '';
                const uid = `${cls.class.replace(/\s+/g, '')}-${startDate.toISOString()}`;
                return [
                    'BEGIN:VEVENT', `UID:${uid}`, `SUMMARY:${cls.class}`, `DTSTAMP:${toUTCFormat(new Date())}`,
                    `DTSTART;TZID=Asia/Kolkata:${startDate.getFullYear()}${(startDate.getMonth()+1).toString().padStart(2,'0')}${startDate.getDate().toString().padStart(2,'0')}T${startDate.getHours().toString().padStart(2,'0')}${startDate.getMinutes().toString().padStart(2,'0')}00`,
                    `DTEND;TZID=Asia/Kolkata:${endDate.getFullYear()}${(endDate.getMonth()+1).toString().padStart(2,'0')}${endDate.getDate().toString().padStart(2,'0')}T${endDate.getHours().toString().padStart(2,'0')}${endDate.getMinutes().toString().padStart(2,'0')}00`,
                    `LOCATION:${cls.location || 'Venue not listed'}`, `DESCRIPTION:Professor: ${cls.professor || 'N/A'}`, 'END:VEVENT'
                ].join('\r\n');
            }).join('\r\n');
            const icsHeader = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//MyClassSchedule//EN', 'BEGIN:VTIMEZONE', 'TZID:Asia/Kolkata', 'BEGIN:STANDARD', 'DTSTART:19700101T000000', 'TZOFFSETFROM:+0530', 'TZOFFSETTO:+0530', 'TZNAME:IST', 'END:STANDARD', 'END:VTIMEZONE'].join('\r\n');
            const icsFooter = 'END:VCALENDAR';
            downloadICS('my_schedule.ics', `${icsHeader}\r\n${icsEvents}\r\n${icsFooter}`);
        }

        // --- LOCALSTORAGE FUNCTIONS ---
        function saveUserPreferences(classesToSave) {
            try { localStorage.setItem('enrolledClasses', JSON.stringify(classesToSave)); showToast('Schedule preferences saved!'); } 
            catch (e) { console.error("Error saving to localStorage:", e); showToast('Failed to save preferences.', 'error'); }
        }

        function fetchUserPreferences() {
            try { const savedClasses = localStorage.getItem('enrolledClasses'); return savedClasses ? JSON.parse(savedClasses) : null; } 
            catch (e) { console.error("Error fetching from localStorage:", e); return null; }
        }

        // --- RENDERING FUNCTIONS ---
        function renderClasses(classes, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (classes.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">üéâ No classes scheduled!</p>'; return; }
            container.innerHTML = classes.map(cls => `
                <div class="class-card">
                    <div>
                        <p class="font-bold text-lg">${cls.class}</p>
                        <p class="opacity-90">üïí ${cls.time || 'N/A'}</p>
                        <p class="opacity-90">üë®‚Äçüè´ ${cls.professor || 'Not listed'}</p>
                        <p class="opacity-90">üìç ${cls.location || 'Not listed'}</p>
                    </div>
                    <a href="${createGoogleCalendarLink(cls)}" target="_blank" class="add-to-calendar-btn" title="Add to Google Calendar">üóìÔ∏è</a>
                </div>
            `).join('');
        }

        function renderUpcomingView(viewType, isRefresh = false) {
            if (!isRefresh) activeUpcomingView = viewType;
            const container = document.getElementById('upcomingClassesContainer');
            const dayWiseBtn = document.getElementById('dayWiseBtn');
            const subjectWiseBtn = document.getElementById('subjectWiseBtn');
            dayWiseBtn.classList.toggle('active', activeUpcomingView === 'dayWise');
            dayWiseBtn.classList.toggle('secondary', activeUpcomingView !== 'dayWise');
            subjectWiseBtn.classList.toggle('active', activeUpcomingView === 'subjectWise');
            subjectWiseBtn.classList.toggle('secondary', activeUpcomingView !== 'subjectWise');
            if (allSheetData.length === 0) { container.innerHTML = '<div class="loader"></div>'; return; }
            if (activeUpcomingView === 'dayWise') renderUpcomingDayWise(container);
            else renderUpcomingSubjectWise(container);
        }

        function renderUpcomingDayWise(container) {
            const today = new Date();
            let content = '';
            for (let i = 0; i < 7; i++) {
                const targetDate = new Date();
                targetDate.setDate(today.getDate() + i);
                const classes = filterAndSortClasses(allSheetData, targetDate);
                if (classes.length > 0) {
                    content += `<div class="mb-4">
                        <h3 class="font-bold border-b pb-1 mb-2">${targetDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</h3>
                        ${classes.map(cls => `<div class="class-card !bg-white !text-gray-800 border-l-4 border-blue-400">
                                <div>
                                    <p class="font-bold">${cls.class}</p>
                                    <p class="text-sm">üïí ${cls.time || 'N/A'} | üë®‚Äçüè´ ${cls.professor || 'N/A'} | üìç ${cls.location || 'N/A'}</p>
                                </div>
                                <a href="${createGoogleCalendarLink(cls)}" target="_blank" class="add-to-calendar-btn !bg-gray-200" title="Add to Google Calendar">üóìÔ∏è</a>
                            </div>`).join('')}
                        </div>`;
                }
            }
            container.innerHTML = content || '<p class="text-gray-500 text-center py-4">üéâ No classes in the next 7 days!</p>';
        }

        function renderUpcomingSubjectWise(container) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const upcomingBySubject = enrolledClasses.map(subject => {
                const nextTwo = allSheetData.filter(row => {
                    const classDate = parseDate(row[0]);
                    if (!classDate || !row[2]) return false; 
                    const classNameFromSheet = parseClassInfo(row[2]).class;
                    return classNameFromSheet.toLowerCase().includes(subject.toLowerCase()) && classDate >= today;
                }).sort((a,b) => {
                    const dateA = parseDate(a[0]), dateB = parseDate(b[0]);
                    if (dateA - dateB !== 0) return dateA - dateB;
                    const timeA = parseTime((a[1] || '').split('-')[0].trim()), timeB = parseTime((b[1] || '').split('-')[0].trim());
                    if (isNaN(timeA.hours) || isNaN(timeB.hours)) return 0;
                    if (timeA.hours !== timeB.hours) return timeA.hours - timeB.hours;
                    return timeA.minutes - timeB.minutes;
                }).slice(0, 2);
                return { subject, nextTwo };
            });
            container.innerHTML = `<table class="w-full text-left">
                <thead><tr class="border-b"><th class="p-2">Subject</th><th class="p-2">Next Class</th><th class="p-2">2nd Next</th></tr></thead>
                <tbody>${upcomingBySubject.map(({ subject, nextTwo }) => `<tr class="border-b">
                        <td class="p-2 font-semibold">${subject}</td>
                        <td class="p-2 text-sm">${nextTwo[0] ? `${nextTwo[0][0]} at ${nextTwo[0][1]}` : 'N/A'}</td>
                        <td class="p-2 text-sm">${nextTwo[1] ? `${nextTwo[1][0]} at ${nextTwo[1][1]}` : 'N/A'}</td>
                    </tr>`).join('')}</tbody>
            </table>`;
        }
        
        // --- DATA & CORE LOGIC ---
        function filterAndSortClasses(data, targetDate) {
            return data.filter(row => {
                const classDate = parseDate(row[0]);
                if (!classDate || !row[2]) return false;
                const classNameFromSheet = parseClassInfo(row[2]).class.toLowerCase();
                return isSameDay(classDate, targetDate) && enrolledClasses.some(enrolledSubject => classNameFromSheet.includes(enrolledSubject.toLowerCase()));
            }).map(row => {
                const classInfo = parseClassInfo(row[2]);
                const classNameLower = classInfo.class.toLowerCase();
                const matchingEnrolledClass = enrolledClasses.find(enrolled => classNameLower.includes(enrolled.toLowerCase()));
                return {
                    date: row[0], time: row[1], class: classInfo.class,
                    location: venueMap[matchingEnrolledClass], professor: professorMap[matchingEnrolledClass]
                };
            }).sort((a, b) => {
                const timeA = parseTime((a.time || '').split('-')[0].trim()), timeB = parseTime((b.time || '').split('-')[0].trim());
                if (isNaN(timeA.hours) || isNaN(timeB.hours)) return 0;
                if (timeA.hours !== timeB.hours) return timeA.hours - timeB.hours;
                return timeA.minutes - timeB.minutes;
            });
        }

        // --- CALENDAR VISUALIZATION LOGIC ---
        function generateMyCalendar() {
             const resultsContainer = document.getElementById('myCalendarResults');
            resultsContainer.innerHTML = '<div class="loader"></div>';

            if (enrolledClasses.length === 0) {
                showToast('Please select your subjects first.', 'error');
                resultsContainer.innerHTML = ''; return;
            }

            const termStartDate = new Date(2025, 8, 10);
            const termEndDate = new Date(2025, 11, 6);
            const myDailySchedule = {};

            allSheetData.forEach(row => {
                const classDate = parseDate(row[0]);
                if (!classDate || !row[2] || classDate < termStartDate || classDate > termEndDate) return;

                const classNameLower = parseClassInfo(row[2]).class.toLowerCase();
                if (enrolledClasses.some(s => classNameLower.includes(s.toLowerCase()))) {
                    const dateKey = classDate.toISOString().split('T')[0];
                    myDailySchedule[dateKey] = (myDailySchedule[dateKey] || 0) + 1;
                }
            });
            
            renderMyCalendar(myDailySchedule, termStartDate, termEndDate);
        }

        function renderMyCalendar(myDailySchedule, termStartDate, termEndDate) {
            const resultsContainer = document.getElementById('myCalendarResults');
            let calendarHtml = `<div class="flex justify-center flex-wrap gap-4 mt-4 text-xs">
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-200 mr-2"></span> Holiday</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-200 mr-2"></span> 1 Class</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-400 mr-2"></span> 2 Classes</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-600 mr-2"></span> 3+ Classes</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-200 mr-2"></span> Outside Term</div>
            </div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">`;

            for (let month = termStartDate.getMonth(); month <= termEndDate.getMonth(); month++) {
                const date = new Date(termStartDate.getFullYear(), month, 1);
                const monthName = date.toLocaleString('default', { month: 'long' });
                
                calendarHtml += `<div><h4 class="text-lg font-semibold text-center mb-2">${monthName} 2025</h4>`;
                calendarHtml += `<div class="calendar-grid">`;
                'Sun,Mon,Tue,Wed,Thu,Fri,Sat'.split(',').forEach(day => calendarHtml += `<div class="calendar-day-header text-center">${day}</div>`);

                for (let i = 0; i < date.getDay(); i++) calendarHtml += `<div></div>`;

                while (date.getMonth() === month) {
                    const dateKey = date.toISOString().split('T')[0];
                    const classCount = myDailySchedule[dateKey] || 0;
                    let dayClass = 'calendar-day';
                    let title = 'No classes';

                    if (date < termStartDate || date > termEndDate) {
                        dayClass += ' day-outside-term';
                        title = 'Outside Term';
                    } else {
                        if (classCount === 0) { dayClass += ' day-free'; }
                        else if (classCount === 1) { dayClass += ' day-light-load'; title = '1 class'; }
                        else if (classCount === 2) { dayClass += ' day-medium-load'; title = '2 classes'; }
                        else { dayClass += ' day-heavy-load'; title = `${classCount} classes`; }
                    }
                    calendarHtml += `<div class="${dayClass}" title="${title}">${date.getDate()}</div>`;
                    date.setDate(date.getDate() + 1);
                }
                calendarHtml += `</div></div>`;
            }
            calendarHtml += `</div>`;
            resultsContainer.innerHTML = calendarHtml;
        }

        // --- FRIEND SCHEDULE COMPARISON LOGIC ---
        function compareSchedules() {
            const resultsContainer = document.getElementById('comparisonResults');
            resultsContainer.innerHTML = '<div class="loader"></div>';

            if (enrolledClasses.length === 0 || friendEnrolledClasses.length === 0) {
                showToast('Please select subjects for both yourself and your friend.', 'error');
                resultsContainer.innerHTML = ''; return;
            }

            const termStartDate = new Date(2025, 8, 10);
            const termEndDate = new Date(2025, 11, 6);
            const dailyStatuses = {};

            allSheetData.forEach(row => {
                const classDate = parseDate(row[0]);
                if (!classDate || !row[2] || classDate < termStartDate || classDate > termEndDate) return;
                const dateKey = classDate.toISOString().split('T')[0];
                if (!dailyStatuses[dateKey]) {
                    dailyStatuses[dateKey] = { userClasses: 0, friendClasses: 0, details: [] };
                }
                const className = parseClassInfo(row[2]).class;
                const classNameLower = className.toLowerCase();
                if (enrolledClasses.some(s => classNameLower.includes(s.toLowerCase()))) {
                    dailyStatuses[dateKey].userClasses++;
                    dailyStatuses[dateKey].details.push({ who: 'You', class: className });
                }
                if (friendEnrolledClasses.some(s => classNameLower.includes(s.toLowerCase()))) {
                    dailyStatuses[dateKey].friendClasses++;
                    dailyStatuses[dateKey].details.push({ who: 'Friend', class: className });
                }
            });

            Object.keys(dailyStatuses).forEach(dateKey => {
                const day = dailyStatuses[dateKey];
                const totalClasses = day.userClasses + day.friendClasses;
                if (totalClasses === 0) day.type = 'free';
                else if (totalClasses === 1) {
                    day.type = 'bunk';
                    day.who = day.details[0].who;
                    day.class = day.details[0].class;
                } else day.type = 'busy';
            });

            renderComparisonCalendar(dailyStatuses, termStartDate, termEndDate);
        }

        function renderComparisonCalendar(dailyStatuses, termStartDate, termEndDate) {
            const resultsContainer = document.getElementById('comparisonResults');
            let calendarHtml = `<div class="flex justify-center flex-wrap gap-4 mt-4 text-xs">
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-200 mr-2"></span> Free</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-200 mr-2"></span> Bunkable</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-200 mr-2"></span> Busy</div>
                <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-200 mr-2"></span> Outside Term</div>
            </div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">`;

            for (let month = termStartDate.getMonth(); month <= termEndDate.getMonth(); month++) {
                const date = new Date(termStartDate.getFullYear(), month, 1);
                const monthName = date.toLocaleString('default', { month: 'long' });
                
                calendarHtml += `<div><h4 class="text-lg font-semibold text-center mb-2">${monthName} 2025</h4>`;
                calendarHtml += `<div class="calendar-grid">`;
                'Sun,Mon,Tue,Wed,Thu,Fri,Sat'.split(',').forEach(day => calendarHtml += `<div class="calendar-day-header text-center">${day}</div>`);
                for (let i = 0; i < date.getDay(); i++) calendarHtml += `<div></div>`;

                while (date.getMonth() === month) {
                    const dateKey = date.toISOString().split('T')[0];
                    const status = dailyStatuses[dateKey] || { type: 'outside' };
                    let dayClass = 'calendar-day';
                    let title = '';

                    if (date < termStartDate || date > termEndDate) {
                         dayClass += ' day-outside-term';
                         title = 'Outside Term';
                    } else {
                        switch (status.type) {
                            case 'free': dayClass += ' day-free'; title = 'Completely Free!'; break;
                            case 'bunk': dayClass += ' day-bunk'; title = `Bunkable! ${status.who} must miss: ${status.class}`; break;
                            case 'busy': dayClass += ' day-busy'; title = 'Busy Day'; break;
                            default: dayClass += ' day-free'; title = 'Completely Free!';
                        }
                    }
                    calendarHtml += `<div class="${dayClass}" title="${title}">${date.getDate()}</div>`;
                    date.setDate(date.getDate() + 1);
                }
                calendarHtml += `</div></div>`;
            }
            calendarHtml += `</div>`;

            let bunkListHtml = '';
            const bunkDays = Object.entries(dailyStatuses)
                .filter(([_, status]) => status.type === 'bunk')
                .map(([dateKey, status]) => ({ date: new Date(dateKey + 'T00:00:00'), ...status }))
                .sort((a, b) => a.date - b.date);

            if (bunkDays.length > 0) {
                bunkListHtml += `<h3 class="font-semibold text-lg mt-6 mb-2 text-gray-800">ü§î Bunking Opportunities Details:</h3>`;
                const bunksByMonth = {};
                bunkDays.forEach(day => {
                    const monthName = day.date.toLocaleString('default', { month: 'long' });
                    if (!bunksByMonth[monthName]) bunksByMonth[monthName] = [];
                    bunksByMonth[monthName].push(day);
                });
                const formatDate = (date) => date.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric' });
                for (const monthName in bunksByMonth) {
                    bunkListHtml += `<h4 class="font-semibold text-md mt-4 mb-1 text-gray-700">${monthName}</h4>`;
                    bunkListHtml += `<ul class="space-y-2 list-disc list-inside">`;
                    bunksByMonth[monthName].forEach(day => {
                        bunkListHtml += `<li class="text-sm text-yellow-800"><span class="font-semibold">${formatDate(day.date)}:</span> ${day.who} must miss class: <span class="font-semibold">${day.class}</span></li>`;
                    });
                    bunkListHtml += `</ul>`;
                }
            }
            resultsContainer.innerHTML = calendarHtml + bunkListHtml;
        }
        
        // --- CORE DATA & INITIALIZATION ---
        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('animate-spin');
            ['todayClasses', 'tomorrowClasses', 'upcomingClassesContainer'].forEach(id => document.getElementById(id).innerHTML = '<div class="loader"></div>');
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                allSheetData = data.values || [];
                
                venueMap = {}; professorMap = {};
                allSheetData.slice(1).forEach(row => {
                    const subject = row[9] ? row[9].trim() : null;
                    const professor = row[10] ? row[10].trim() : null;
                    const venue = row[11] ? row[11].trim() : null;
                    if (subject) {
                        if (professor && !professorMap[subject]) professorMap[subject] = professor;
                        if (venue && !venueMap[subject]) venueMap[subject] = venue;
                    }
                });
                
                const uniqueMasterClasses = new Set(allSheetData.slice(1).map(row => row[9] ? row[9].trim() : null).filter(Boolean));
                allClasses = [...uniqueMasterClasses].sort();
                
                document.getElementById('connectionStatus').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                document.getElementById('connectionStatus').className = 'text-green-500 mt-2';
                
                renderClasses(filterAndSortClasses(allSheetData, new Date()), 'todayClasses');
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                renderClasses(filterAndSortClasses(allSheetData, tomorrow), 'tomorrowClasses');
                renderUpcomingView(activeUpcomingView, true);

            } catch (error) {
                console.error("Failed to fetch data:", error);
                document.getElementById('connectionStatus').textContent = '‚ö†Ô∏è Connection Failed';
                document.getElementById('connectionStatus').className = 'text-red-500 mt-2';
            } finally {
                refreshBtn.classList.remove('animate-spin');
            }
        }

        function fetchClassesForDate() {
            const dateStr = document.getElementById('datePicker').value;
            if (!dateStr) { showToast('Please select a date.', 'error'); return; }
            const [year, month, day] = dateStr.split('-').map(Number);
            const selectedDate = new Date(year, month - 1, day);
            renderClasses(filterAndSortClasses(allSheetData, selectedDate), 'selectedDateClasses');
        }

        function setupSubjectSearch(inputId, resultsId, tagsId, targetArray) {
            const searchInput = document.getElementById(inputId);
            const resultsContainer = document.getElementById(resultsId);
            const tagsContainer = document.getElementById(tagsId);

            const renderTags = () => {
                tagsContainer.innerHTML = targetArray.map(subject => `
                    <div class="bg-blue-500 text-white px-3 py-1 rounded-full flex items-center gap-2 text-sm">
                        <span>${subject}</span>
                        <button class="font-bold remove-tag-btn" data-subject="${subject}" data-target="${tagsId}">x</button>
                    </div>
                `).join('');
            };

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (!query) { resultsContainer.classList.add('hidden'); return; }
                const filtered = allClasses.filter(c => c.toLowerCase().includes(query) && !targetArray.includes(c));
                resultsContainer.innerHTML = filtered.map(c => `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-subject="${c}">${c}</div>`).join('');
                resultsContainer.classList.toggle('hidden', filtered.length === 0);
            });

            resultsContainer.addEventListener('click', e => {
                if (e.target.dataset.subject) {
                    targetArray.push(e.target.dataset.subject);
                    targetArray.sort();
                    renderTags();
                    searchInput.value = '';
                    resultsContainer.classList.add('hidden');
                }
            });
             tagsContainer.addEventListener('click', event => {
                const button = event.target.closest('.remove-tag-btn');
                if (button && button.dataset.target === tagsId) {
                    const subject = button.dataset.subject;
                    const index = targetArray.indexOf(subject);
                    if (index > -1) targetArray.splice(index, 1);
                    renderTags();
                }
            });
            renderTags();
            return renderTags;
        }

        function initialize() {
            const today = new Date();
            document.getElementById('todayDate').textContent = `(${today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
            const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1);
            document.getElementById('tomorrowDate').textContent = `(${tomorrow.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
            document.getElementById('datePicker').valueAsDate = today;
            
            const savedClasses = fetchUserPreferences();
            if (savedClasses) enrolledClasses = savedClasses;

            const renderUserTags = setupSubjectSearch('subjectSearchInput', 'searchResults', 'selectedTagsContainer', enrolledClasses);
            const renderFriendTags = setupSubjectSearch('friendSubjectSearchInput', 'friendSearchResults', 'friendSelectedTagsContainer', friendEnrolledClasses);

            document.addEventListener('click', e => {
                if (!e.target.closest('.relative')) {
                    document.getElementById('searchResults').classList.add('hidden');
                    document.getElementById('friendSearchResults').classList.add('hidden');
                }
            });

            document.getElementById('updateScheduleBtn').addEventListener('click', () => {
                saveUserPreferences(enrolledClasses);
                refreshData();
            });
            document.getElementById('downloadMonthBtn').addEventListener('click', generateMonthlyICS);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('dayWiseBtn').addEventListener('click', () => renderUpcomingView('dayWise'));
            document.getElementById('subjectWiseBtn').addEventListener('click', () => renderUpcomingView('subjectWise'));
            document.getElementById('showScheduleBtn').addEventListener('click', fetchClassesForDate);
            document.getElementById('showMyCalendarBtn').addEventListener('click', generateMyCalendar);
            document.getElementById('compareSchedulesBtn').addEventListener('click', compareSchedules);

            refreshData().then(() => {
                renderUserTags();
                renderFriendTags();
            });
        }

        initialize();
    </script>
</body>
</html>

