<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Schedule</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F0F4F8; /* A cool, light blue-gray background */
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            border: 1px solid #E2E8F0;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .card-title {
            font-weight: 600;
            color: #2D3748; /* A dark, professional blue */
        }
        .class-card {
            background-color: #4A5568; /* Solid, high-contrast background */
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #4A90E2; /* Accent color for visual flair */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn {
            background-color: #4A90E2;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #357ABD;
        }
        .btn.active {
            background-color: #2D3748;
        }
        .btn.secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }
        .btn.secondary:hover {
            background-color: #CBD5E0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .add-to-calendar-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 1.2rem;
            transition: background-color 0.2s;
        }
        .add-to-calendar-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#2D3748]">Class Schedule üìö</h1>
            <p id="connectionStatus" class="text-gray-500 mt-2">Connecting...</p>
        </header>

        <!-- Main Content -->
        <main id="scheduleContent" class="flex flex-col gap-6">
            
            <!-- Select Your Classes -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">‚úÖ My Subjects</h2>
                <div class="relative mb-4">
                    <input type="text" id="subjectSearchInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Search and add a subject...">
                    <div id="searchResults" class="absolute top-full left-0 w-full bg-white border border-gray-300 rounded-b-lg z-10 hidden max-h-60 overflow-y-auto"></div>
                </div>
                <div id="selectedTagsContainer" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="updateScheduleBtn" class="btn w-full">Update My Schedule</button>
                    <button id="downloadMonthBtn" class="btn w-full !bg-green-500 hover:!bg-green-600 leading-tight">Download my latest custom calendar</button>
                </div>
            </div>

            <!-- Today & Tomorrow -->
            <section class="grid md:grid-cols-2 gap-6">
                <div class="card">
                    <h2 class="card-title text-xl mb-4">üìÖ Today <span class="text-gray-400 font-normal text-sm" id="todayDate"></span></h2>
                    <div id="todayClasses"><div class="loader"></div></div>
                </div>
                <div class="card">
                    <h2 class="card-title text-xl mb-4">‚è≠Ô∏è Tomorrow <span class="text-gray-400 font-normal text-sm" id="tomorrowDate"></span></h2>
                    <div id="tomorrowClasses"><div class="loader"></div></div>
                </div>
            </section>

            <!-- Upcoming Classes -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">‚û°Ô∏è Upcoming Schedule</h2>
                <div class="flex gap-2 mb-4">
                    <button id="dayWiseBtn" class="btn active flex-grow">Day-wise</button>
                    <button id="subjectWiseBtn" class="btn secondary flex-grow">Subject-wise</button>
                </div>
                <div id="upcomingClassesContainer"><div class="loader"></div></div>
            </div>

            <!-- Search by Date -->
            <div class="card">
                <h2 class="card-title text-xl mb-4">üîç Search by Date</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="date" id="datePicker" class="w-full p-3 border border-gray-300 rounded-lg">
                    <button id="showScheduleBtn" class="btn w-full md:w-auto">Show Schedule</button>
                </div>
                <div id="selectedDateClasses" class="mt-4"></div>
            </div>
            
            <!-- Back to Home Button -->
            <div class="text-center mt-8">
                <a href="./index.html" class="inline-block bg-gray-200 text-gray-700 py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">üè† Back to Home</a>
            </div>

        </main>
    </div>

    <!-- Floating Refresh Button -->
    <button class="refresh-btn fixed bottom-5 right-5 bg-blue-500 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-2xl" id="refreshBtn" title="Refresh Data">
        üîÑ
    </button>
    
    <script>
        // --- APPLICATION LOGIC ---
        const API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1386awb-Qw-_ld03zlXFNfkkHi7N9XY4LwirxQtkMpZk/values/New!A1:N1300?key=AIzaSyBQps5D4hUe8owgZOe4-qgFwoXwl5x6ATo';
        
        let allSheetData = [];
        let enrolledClasses = ['IBA (S2)', 'DBTS (S2)', 'B2B', 'DOPM', 'SAPM (S2)'];
        let activeUpcomingView = 'dayWise';
        let allClasses = [];
        let venueMap = {};
        let professorMap = {};

        // --- UTILITY FUNCTIONS ---
        function setConnectionStatus(isConnected, message = 'Connected') {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = isConnected ? message : '‚ö†Ô∏è Connection Failed';
            statusEl.className = isConnected ? 'text-green-500 mt-2' : 'text-red-500 mt-2';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.trim().split('/');
            if (parts.length === 3) {
                const [month, day, year] = parts.map(p => parseInt(p, 10));
                if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                    return new Date(year, month - 1, day);
                }
            }
            return null;
        }

        function isSameDay(d1, d2) {
            if (!d1 || !d2) return false;
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        }

        function parseClassInfo(classString) {
            if (!classString) return { class: 'Unnamed Class', instructor: '' };
            const separatorIndex = classString.indexOf(' - ');
            if (separatorIndex !== -1) {
                return {
                    class: classString.substring(0, separatorIndex).trim(),
                    instructor: classString.substring(separatorIndex + 3).trim()
                };
            }
            return { class: classString.trim(), instructor: '' };
        }
        
        function parseTime(timeStr) {
            if (!timeStr) return { hours: NaN, minutes: NaN };
            const parts = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
            if (!parts) return { hours: NaN, minutes: NaN };
            let hours = parseInt(parts[1], 10);
            const minutes = parseInt(parts[2], 10);
            const modifier = parts[3];
            if (isNaN(hours) || isNaN(minutes)) return { hours: NaN, minutes: NaN };
            if (modifier) {
                if (modifier.toUpperCase() === 'PM' && hours < 12) hours += 12;
                if (modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
            }
            return { hours, minutes };
        }

        // --- ICS FILE GENERATION ---
        function downloadICS(filename, content) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toUTCFormat(date) {
            return date.toISOString().replace(/[-:.]/g, '').slice(0, -4) + 'Z';
        }

        function createGoogleCalendarLink(cls) {
            const classDate = parseDate(cls.date);
            if (!classDate) return '#';
            const timeParts = (cls.time || '').split('-').map(t => t.trim());
            if (timeParts.length < 2) return '#';
            const { hours: startHours, minutes: startMinutes } = parseTime(timeParts[0]);
            const { hours: endHours, minutes: endMinutes } = parseTime(timeParts[1]);
            if (isNaN(startHours) || isNaN(endHours)) return '#';
            const startDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), startHours, startMinutes);
            const endDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), endHours, endMinutes);
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return '#';
            const baseURL = 'https://www.google.com/calendar/render?action=TEMPLATE';
            const params = new URLSearchParams({
                text: cls.class,
                dates: `${toUTCFormat(startDate)}/${toUTCFormat(endDate)}`,
                details: `Professor: ${cls.professor || 'N/A'}`,
                location: cls.location || 'Venue not listed'
            });
            return `${baseURL}&${params.toString()}`;
        }
        
        function generateMonthlyICS() {
            if (enrolledClasses.length === 0) {
                showToast('Please select your subjects first.', 'error');
                return;
            }
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            const eventsForNextMonth = allSheetData
                .map(row => {
                    const classDate = parseDate(row[0]);
                    const classInfo = parseClassInfo(row[2] || '');
                    if (classDate && classDate >= today && classDate <= nextMonth && enrolledClasses.includes(classInfo.class)) {
                        return {
                            date: row[0], time: row[1], class: classInfo.class,
                            instructor: classInfo.instructor, 
                            location: venueMap[classInfo.class],
                            professor: professorMap[classInfo.class]
                        };
                    }
                    return null;
                }).filter(Boolean);
            if (eventsForNextMonth.length === 0) {
                showToast('No classes found for your subjects in the next 30 days.');
                return;
            }
            let icsEvents = eventsForNextMonth.map(cls => {
                const classDate = parseDate(cls.date);
                if (!classDate) return '';
                const timeParts = (cls.time || '').split('-').map(t => t.trim());
                if (timeParts.length < 2) return '';
                const { hours: startHours, minutes: startMinutes } = parseTime(timeParts[0]);
                const { hours: endHours, minutes: endMinutes } = parseTime(timeParts[1]);
                if (isNaN(startHours) || isNaN(endHours)) return '';
                const startDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), startHours, startMinutes);
                const endDate = new Date(classDate.getFullYear(), classDate.getMonth(), classDate.getDate(), endHours, endMinutes);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return '';
                const uid = `${cls.class.replace(/\s+/g, '')}-${startDate.toISOString()}`;
                return [
                    'BEGIN:VEVENT', `UID:${uid}`, `SUMMARY:${cls.class}`, `DTSTAMP:${toUTCFormat(new Date())}`,
                    `DTSTART;TZID=Asia/Kolkata:${startDate.getFullYear()}${(startDate.getMonth()+1).toString().padStart(2,'0')}${startDate.getDate().toString().padStart(2,'0')}T${startDate.getHours().toString().padStart(2,'0')}${startDate.getMinutes().toString().padStart(2,'0')}00`,
                    `DTEND;TZID=Asia/Kolkata:${endDate.getFullYear()}${(endDate.getMonth()+1).toString().padStart(2,'0')}${endDate.getDate().toString().padStart(2,'0')}T${endDate.getHours().toString().padStart(2,'0')}${endDate.getMinutes().toString().padStart(2,'0')}00`,
                    `LOCATION:${cls.location || 'Venue not listed'}`, `DESCRIPTION:Professor: ${cls.professor || 'N/A'}`, 'END:VEVENT'
                ].join('\r\n');
            }).join('\r\n');
            const icsHeader = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//MyClassSchedule//EN', 'BEGIN:VTIMEZONE', 'TZID:Asia/Kolkata', 'BEGIN:STANDARD', 'DTSTART:19700101T000000', 'TZOFFSETFROM:+0530', 'TZOFFSETTO:+0530', 'TZNAME:IST', 'END:STANDARD', 'END:VTIMEZONE'].join('\r\n');
            const icsFooter = 'END:VCALENDAR';
            const fullIcsContent = `${icsHeader}\r\n${icsEvents}\r\n${icsFooter}`;
            downloadICS('my_schedule.ics', fullIcsContent);
        }

        // --- LOCALSTORAGE FUNCTIONS ---
        function saveUserPreferences(classesToSave) {
            try {
                localStorage.setItem('enrolledClasses', JSON.stringify(classesToSave));
                showToast('Schedule preferences saved!');
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                showToast('Failed to save preferences.', 'error');
            }
        }

        function fetchUserPreferences() {
            try {
                const savedClasses = localStorage.getItem('enrolledClasses');
                return savedClasses ? JSON.parse(savedClasses) : null;
            } catch (e) {
                console.error("Error fetching from localStorage:", e);
                return null;
            }
        }

        // --- RENDERING FUNCTIONS ---
        function renderClasses(classes, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (classes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">üéâ No classes scheduled!</p>';
                return;
            }
            container.innerHTML = classes.map(cls => `
                <div class="class-card">
                    <div>
                        <p class="font-bold text-lg">${cls.class}</p>
                        <p class="opacity-90">üïí ${cls.time || 'N/A'}</p>
                        <p class="opacity-90">üë®‚Äçüè´ ${cls.professor || 'Not listed'}</p>
                        <p class="opacity-90">üìç ${cls.location || 'Not listed'}</p>
                    </div>
                    <a href="${createGoogleCalendarLink(cls)}" target="_blank" class="add-to-calendar-btn" title="Add to Google Calendar">üóìÔ∏è</a>
                </div>
            `).join('');
        }

        function renderUpcomingView(viewType, isRefresh = false) {
            if (!isRefresh) activeUpcomingView = viewType;
            const container = document.getElementById('upcomingClassesContainer');
            const dayWiseBtn = document.getElementById('dayWiseBtn');
            const subjectWiseBtn = document.getElementById('subjectWiseBtn');
            dayWiseBtn.classList.toggle('active', activeUpcomingView === 'dayWise');
            dayWiseBtn.classList.toggle('secondary', activeUpcomingView !== 'dayWise');
            subjectWiseBtn.classList.toggle('active', activeUpcomingView === 'subjectWise');
            subjectWiseBtn.classList.toggle('secondary', activeUpcomingView !== 'subjectWise');
            if (allSheetData.length === 0) {
                container.innerHTML = '<div class="loader"></div>';
                return;
            }
            if (activeUpcomingView === 'dayWise') renderUpcomingDayWise(container);
            else renderUpcomingSubjectWise(container);
        }

        function renderUpcomingDayWise(container) {
            const today = new Date();
            let content = '';
            for (let i = 0; i < 7; i++) {
                const targetDate = new Date();
                targetDate.setDate(today.getDate() + i);
                const classes = filterAndSortClasses(allSheetData, targetDate);
                if (classes.length > 0) {
                    content += `
                        <div class="mb-4">
                            <h3 class="font-bold border-b pb-1 mb-2">${targetDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</h3>
                            ${classes.map(cls => `
                                <div class="class-card !bg-white !text-gray-800 border-l-4 border-blue-400">
                                    <div>
                                        <p class="font-bold">${cls.class}</p>
                                        <p class="text-sm">üïí ${cls.time || 'N/A'} | üë®‚Äçüè´ ${cls.professor || 'N/A'} | üìç ${cls.location || 'N/A'}</p>
                                    </div>
                                    <a href="${createGoogleCalendarLink(cls)}" target="_blank" class="add-to-calendar-btn !bg-gray-200" title="Add to Google Calendar">üóìÔ∏è</a>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            container.innerHTML = content || '<p class="text-gray-500 text-center py-4">üéâ No classes in the next 7 days!</p>';
        }

        function renderUpcomingSubjectWise(container) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const upcomingBySubject = enrolledClasses.map(subject => {
                const nextTwo = allSheetData
                    .filter(row => {
                        const classDate = parseDate(row[0]);
                        return parseClassInfo(row[2] || '').class === subject && classDate && classDate >= today;
                    })
                    .sort((a,b) => {
                        const dateA = parseDate(a[0]);
                        const dateB = parseDate(b[0]);
                        if (dateA - dateB !== 0) return dateA - dateB;
                        const timeA = parseTime((a[1] || '').split('-')[0].trim());
                        const timeB = parseTime((b[1] || '').split('-')[0].trim());
                        if (isNaN(timeA.hours) || isNaN(timeB.hours)) return 0;
                        if (timeA.hours !== timeB.hours) return timeA.hours - timeB.hours;
                        return timeA.minutes - timeB.minutes;
                    })
                    .slice(0, 2);
                return { subject, nextTwo };
            });
            container.innerHTML = `
                <table class="w-full text-left">
                    <thead><tr class="border-b"><th class="p-2">Subject</th><th class="p-2">Next Class</th><th class="p-2">2nd Next</th></tr></thead>
                    <tbody>
                    ${upcomingBySubject.map(({ subject, nextTwo }) => `
                        <tr class="border-b">
                            <td class="p-2 font-semibold">${subject}</td>
                            <td class="p-2 text-sm">${nextTwo[0] ? `${nextTwo[0][0]} at ${nextTwo[0][1]}` : 'N/A'}</td>
                            <td class="p-2 text-sm">${nextTwo[1] ? `${nextTwo[1][0]} at ${nextTwo[1][1]}` : 'N/A'}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedTagsContainer');
            container.innerHTML = enrolledClasses.map(subject => `
                <div class="bg-blue-500 text-white px-3 py-1 rounded-full flex items-center gap-2 text-sm">
                    <span>${subject}</span>
                    <button class="font-bold remove-tag-btn" data-subject="${subject}">x</button>
                </div>
            `).join('');
        }

        // --- DATA & CORE LOGIC ---
        function filterAndSortClasses(data, targetDate) {
            return data
                .filter(row => {
                    const classDate = parseDate(row[0]);
                    const className = parseClassInfo(row[2] || '').class;
                    return classDate && isSameDay(classDate, targetDate) && enrolledClasses.includes(className);
                })
                .map(row => {
                    const classInfo = parseClassInfo(row[2] || '');
                    return {
                        date: row[0], time: row[1], class: classInfo.class,
                        instructor: classInfo.instructor, 
                        location: venueMap[classInfo.class],
                        professor: professorMap[classInfo.class]
                    };
                })
                .sort((a, b) => {
                    const timeA = parseTime((a.time || '').split('-')[0].trim());
                    const timeB = parseTime((b.time || '').split('-')[0].trim());
                    if (isNaN(timeA.hours) || isNaN(timeB.hours)) return 0;
                    if (timeA.hours !== timeB.hours) return timeA.hours - timeB.hours;
                    return timeA.minutes - timeB.minutes;
                });
        }

        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('animate-spin');
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                const data = await response.json();
                allSheetData = data.values || [];
                setConnectionStatus(true, `Last updated: ${new Date().toLocaleTimeString()}`);

                // Build the venue and professor maps
                venueMap = {};
                professorMap = {};
                allSheetData.slice(1).forEach(row => {
                    const subject = row[9] ? row[9].trim() : null; // Column J
                    const professor = row[10] ? row[10].trim() : null; // Column K
                    const venue = row[11] ? row[11].trim() : null; // Column L
                    if (subject) {
                        if (professor && !professorMap[subject]) professorMap[subject] = professor;
                        if (venue && !venueMap[subject]) venueMap[subject] = venue;
                    }
                });

                const lastUpdatedDate = allSheetData[0] ? allSheetData[0][6] : null; // G1 is at index 6
                const downloadBtn = document.getElementById('downloadMonthBtn');
                if (lastUpdatedDate) {
                    downloadBtn.innerHTML = `Download my latest custom calendar <span class="text-xs font-normal block">(Updated: ${lastUpdatedDate})</span>`;
                } else {
                    downloadBtn.textContent = 'Download my latest custom calendar';
                }

                const uniqueClasses = new Set(allSheetData.slice(1).map(row => parseClassInfo(row[2] || '').class).filter(Boolean));
                allClasses = [...uniqueClasses].sort();
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);
                renderClasses(filterAndSortClasses(allSheetData, today), 'todayClasses');
                renderClasses(filterAndSortClasses(allSheetData, tomorrow), 'tomorrowClasses');
                renderUpcomingView(activeUpcomingView, true);
            } catch (error) {
                console.error("Failed to fetch Google Sheet data:", error);
                setConnectionStatus(false);
                showToast('Failed to refresh data. Check sheet permissions.', 'error');
            } finally {
                refreshBtn.classList.remove('animate-spin');
            }
        }

        function fetchClassesForDate() {
            const dateStr = document.getElementById('datePicker').value;
            if (!dateStr) {
                showToast('Please select a date.', 'error');
                return;
            }
            const [year, month, day] = dateStr.split('-').map(Number);
            const selectedDate = new Date(year, month - 1, day);
            renderClasses(filterAndSortClasses(allSheetData, selectedDate), 'selectedDateClasses');
        }

        function removeTag(subjectToRemove) {
            enrolledClasses = enrolledClasses.filter(s => s !== subjectToRemove);
            renderSelectedTags();
        }

        function updateEnrolledClassesAndRefresh() {
            saveUserPreferences(enrolledClasses);
            refreshData();
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        function setupEventListeners() {
            const searchInput = document.getElementById('subjectSearchInput');
            const resultsContainer = document.getElementById('searchResults');
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (!query) {
                    resultsContainer.classList.add('hidden');
                    return;
                }
                const filtered = allClasses.filter(c => c.toLowerCase().includes(query) && !enrolledClasses.includes(c));
                resultsContainer.innerHTML = filtered.map(c => `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-subject="${c}">${c}</div>`).join('');
                resultsContainer.classList.remove('hidden');
            });
            resultsContainer.addEventListener('click', (e) => {
                if (e.target.dataset.subject) {
                    enrolledClasses.push(e.target.dataset.subject);
                    enrolledClasses.sort();
                    renderSelectedTags();
                    searchInput.value = '';
                    resultsContainer.classList.add('hidden');
                }
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                    resultsContainer.classList.add('hidden');
                }
            });
            document.getElementById('selectedTagsContainer').addEventListener('click', (event) => {
                const button = event.target.closest('.remove-tag-btn');
                if (button) {
                    removeTag(button.dataset.subject);
                }
            });
            document.getElementById('updateScheduleBtn').addEventListener('click', updateEnrolledClassesAndRefresh);
            document.getElementById('downloadMonthBtn').addEventListener('click', generateMonthlyICS);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('dayWiseBtn').addEventListener('click', () => renderUpcomingView('dayWise'));
            document.getElementById('subjectWiseBtn').addEventListener('click', () => renderUpcomingView('subjectWise'));
            document.getElementById('showScheduleBtn').addEventListener('click', fetchClassesForDate);
        }

        function initialize() {
            const today = new Date();
            document.getElementById('todayDate').textContent = `(${today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            document.getElementById('tomorrowDate').textContent = `(${tomorrow.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
            document.getElementById('datePicker').valueAsDate = today;
            setupEventListeners();
            const savedClasses = fetchUserPreferences();
            if (savedClasses && savedClasses.length > 0) {
                enrolledClasses = savedClasses;
            }
            renderSelectedTags();
            refreshData();
        }

        initialize();
    </script>
</body>
</html>
